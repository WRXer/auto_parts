{% extends 'main/base.html' %}
{% load static %}
{% load cache %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äì –ú–∞—Ä–∫–µ—Ç –ó–∞–ø—á–∞—Å—Ç–µ–π CheapAutoParts64{% endblock %}
{% block content %}

<link rel="stylesheet" href="{% static 'deps/css/profile_styles.css' %}">

<main class="container text-dark py-5 rounded-4 shadow-lg" style="background-color: rgba(255, 255, 255, 0.9);">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-12">
            <h2 class="text-center mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

            <div class="row g-4">
                <div class="col-md-4">
                    <ul class="nav nav-pills flex-column shadow-sm p-3 rounded-3 bg-light" id="profileTabs" role="tablist">

                        <li class="nav-item mb-2" role="presentation">
                            <button class="nav-link active w-100 text-start" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-content" type="button" role="tab" aria-controls="data-content" aria-selected="true">
                                <i class="fas fa-user me-2"></i> –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ
                            </button>
                        </li>

                        <li class="nav-item mb-2" role="presentation">
                            <button class="nav-link w-100 text-start" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-content" type="button" role="tab" aria-controls="orders-content" aria-selected="false">
                                <i class="fas fa-box-open me-2"></i> –ú–æ–∏ –∑–∞–∫–∞–∑—ã
                            </button>
                        </li>

                        {% if user.is_staff or user.is_superuser %}
                        <li class="nav-item mb-2" role="presentation">
                            <button class="nav-link w-100 text-start" id="all-orders-tab" data-bs-toggle="tab" data-bs-target="#all-orders-content" type="button" role="tab" aria-controls="all-orders-content" aria-selected="false">
                                <i class="fas fa-clipboard-list me-2"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤
                            </button>
                        </li>
                        <li class="nav-item mb-2" role="presentation">
                            <button class="nav-link w-100 text-start" id="all-users-tab" data-bs-toggle="tab" data-bs-target="#all-users-content" type="button" role="tab" aria-controls="all-users-content" aria-selected="false">
                                <i class="fas fa-users me-2"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                            </button>
                        </li>

                            {# üîë –ù–û–í–ê–Ø –í–ö–õ–ê–î–ö–ê –î–õ–Ø –ê–î–ú–ò–ù–ê #}
                            <li class="nav-item mb-2" role="presentation">
                                <button class="nav-link w-100 text-start" id="data-update-tab" data-bs-toggle="tab" data-bs-target="#data-update-content" type="button" role="tab" aria-controls="data-update-content" aria-selected="false">
                                    <i class="fas fa-sync-alt me-2"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞
                                </button>
                            </li>
                        {% endif %}


                        <li class="nav-item" role="presentation">
                            <a href="{% url 'users:password_change' %}" class="nav-link w-100 text-start" aria-label="–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å">
                                <i class="fas fa-key me-2"></i> –ü–∞—Ä–æ–ª—å
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-md-8">
                    <div class="tab-content" id="profileTabsContent">

                        <div class="tab-pane fade show active" id="data-content" role="tabpanel" aria-labelledby="data-tab">
                            <div class="card p-4 shadow-sm">
                                <h4 class="card-title mb-3">
                                    {% if mode == 'edit' %}
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                                    {% else %}
                                        –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
                                    {% endif %}
                                </h4>

                                    <dl class="row">
                                        <dt class="col-sm-4 text-muted">–ò–º—è:</dt>
                                        <dd class="col-sm-8">{{ user.first_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>

                                        <dt class="col-sm-4 text-muted">–§–∞–º–∏–ª–∏—è:</dt>
                                        <dd class="col-sm-8">{{ user.last_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>

                                        <dt class="col-sm-4 text-muted">Email:</dt>
                                        <dd class="col-sm-8">{{ user.email|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>

                                        <dt class="col-sm-4 text-muted">–¢–µ–ª–µ—Ñ–æ–Ω:</dt>
                                        <dd class="col-sm-8">{{ user.phone|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</dd>
                                    </dl>

                                    <div class="d-flex justify-content-end">
                                        <a href="{% url 'users:profile_edit' %}" class="btn btn-success mt-3">
                                            <i class="fas fa-edit me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </a>
                                    </div>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="orders-content" role="tabpanel" aria-labelledby="orders-tab">
                            <div class="card p-4 shadow-sm">
                                <h4 class="card-title mb-3">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h4>

                                {% if orders %}
                                    <div class="accordion" id="ordersAccordion">
                                        {% cache 60 userorders user.id %}
                                        {% for order in orders %}
                                            <div class="accordion-item mb-3 rounded-3 shadow-sm border">
                                                <h2 class="accordion-header" id="heading-{{ order.id }}">
                                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} p-3"
                                                            type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#collapse-{{ order.id }}"
                                                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                                            aria-controls="collapse-{{ order.id }}">
                                                        <div class="d-flex justify-content-between w-100 pe-3">
                                                            <div class="fw-bold text-dark me-4">
                                                                –ó–∞–∫–∞–∑ #{{ order.id }}
                                                            <span class="badge bg-secondary">{{ order.get_status_display }}</span>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <span class="fw-bold text-dark me-4">{{ order.get_total_price|floatformat:0 }}&nbsp;‚ÇΩ</span>
                                                            </div>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="collapse-{{ order.id }}"
                                                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                                                     aria-labelledby="heading-{{ order.id }}"
                                                     data-bs-parent="#ordersAccordion">

                                                    <div class="accordion-body p-3">
                                                        <div class="fw-bold text-dark me-4">
                                                            {% if order.delivery_address %}
                                                                {{ order.delivery_address }}
                                                                    {% else %}
                                                                        –°–∞–º–æ–≤—ã–≤–æ–∑
                                                            {% endif %}
                                                        </div>
                                                        <p class="fw-bold text-muted mb-2 border-bottom pb-1">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>

                                                        <ul class="list-unstyled">
                                                            {% for item in order.items.all %}
                                                                <li class="d-flex align-items-center mb-2 pb-2 border-bottom">

                                                                    {% with image_url=item.part.get_main_image_source %}
                                                                        {% if item.part and image_url %}
                                                                            <img src="{{ image_url }}" alt="{{ item.name }}"
                                                                                 class="me-3 rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                                                        {% else %}
                                                                            <i class="fas fa-box-open fa-2x me-3 text-secondary" style="width: 50px; height: 50px;"></i>
                                                                        {% endif %}
                                                                    {% endwith %}

                                                                    <div class="d-flex flex-column flex-grow-1 me-3">
                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                            <a href="#"
                                                                               data-url="{% url 'spare_parts:part_detail_modal_in_cart' item.part.pk %}"
                                                                               class="text-dark fw-bold text-decoration-none js-open-part-modal me-2"
                                                                               style="cursor: pointer;">
                                                                                {{ item.name|default:"–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                                                            </a>
                                                                            <div class="fw-normal text-muted text-end fs-7 flex-shrink-0">
                                                                                {{ item.quantity }}&nbsp;—à—Ç. &times; {{ item.price|floatformat:0 }} ‚ÇΩ
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                        {% endcache %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning text-center" role="alert">
                                        –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.
                                    </div>
                                {% endif %}

                                <div class="mt-3 text-center">
                                     <a href="{% url 'index' %}" class="btn btn-success">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
                                </div>
                            </div>
                        </div>

                        {% if user.is_staff or user.is_superuser %}
                            <div class="tab-pane fade" id="all-orders-content" role="tabpanel" aria-labelledby="all-orders-tab">
                                <div class="card p-4 shadow-sm">
                                    <h4 class="card-title mb-3">–í—Å–µ –∑–∞–∫–∞–∑—ã —Å–∏—Å—Ç–µ–º—ã</h4>
                                    {% if all_orders %}
                                        <div class="accordion" id="adminOrdersAccordion">
                                            {% for order in all_orders %}
                                                <div class="accordion-item mb-3 rounded-3 shadow-sm border">
                                                    <h2 class="accordion-header d-flex justify-content-between align-items-center p-0" id="admin-heading-{{ order.id }}">
                                                        <button class="accordion-button collapsed p-3 flex-grow-1"
                                                                type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#admin-collapse-{{ order.id }}"
                                                                aria-expanded="false"
                                                                aria-controls="admin-collapse-{{ order.id }}"
                                                                style="width: auto;">

                                                            <div class="d-flex justify-content-between align-items-center w-100 pe-3">

                                                                {# 1. –ë–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ (–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞) #}
                                                                <div class="d-flex flex-column me-4 text-start">
                                                                    <div class="fw-bold text-dark">
                                                                        –ó–∞–∫–∞–∑ #{{ order.id }}
                                                                    </div>
                                                                    <small class="text-muted">
                                                                        –ö–ª–∏–µ–Ω—Ç: {% if order.user %}{{ order.user.email }}{% else %} –ì–æ—Å—Ç—å ({{ order.email }}){% endif %}
                                                                    </small>
                                                                </div>

                                                                {# 2. –ë–ª–æ–∫ —Å—É–º–º—ã (–í—ã—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è –≤–ø—Ä–∞–≤–æ –∫–ª–∞—Å—Å–æ–º justify-content-between) #}
                                                                <span class="fw-bold text-dark flex-shrink-0">
                                                                    {{ order.get_total_price|floatformat:0 }}&nbsp;‚ÇΩ
                                                                </span>
                                                            </div>
                                                        </button>
                                                    </h2>

                                                    <div id="admin-collapse-{{ order.id }}"
                                                         class="accordion-collapse collapse"
                                                         aria-labelledby="admin-heading-{{ order.id }}"
                                                         data-bs-parent="#adminOrdersAccordion">
                                                        <div class="accordion-body p-3">
                                                        <div class="row g-2 mb-3 border-bottom pb-3">

                                                                {# –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã (col-12 –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) #}
                                                                <div class="col-12 col-md-6">
                                                                    <form action="{% url 'orders:update_paid_status' order.id %}" method="post" class="admin-paid-form">
                                                                        {% csrf_token %}
                                                                        <div class="input-group input-group-sm order-status-input">
                                                                            <span class="input-group-text bg-light fw-bold text-muted">–û–ø–ª–∞—Ç–∞</span>
                                                                            <select name="is_paid" class="form-select" data-order-id="{{ order.id }}">
                                                                                <option value="False" {% if not order.is_paid %}selected{% endif %}>–ù–µ –æ–ø–ª–∞—á–µ–Ω</option>
                                                                                <option value="True" {% if order.is_paid %}selected{% endif %}>–û–ø–ª–∞—á–µ–Ω</option>
                                                                            </select>
                                                                        </div>
                                                                    </form>
                                                                </div>

                                                                {# –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #}
                                                                <div class="col-12 col-md-6">
                                                                    <form action="{% url 'orders:update_status' order.id %}" method="post" class="admin-status-form">
                                                                        {% csrf_token %}
                                                                        <div class="input-group input-group-sm order-status-input">
                                                                            <span class="input-group-text bg-light fw-bold text-muted">–°—Ç–∞—Ç—É—Å</span>
                                                                            <select name="status" class="form-select" data-order-id="{{ order.id }}">
                                                                                {% for status_val, status_display in order.STATUS_CHOICES %}
                                                                                    <option value="{{ status_val }}" {% if order.status == status_val %}selected{% endif %}>
                                                                                        {{ status_display }}
                                                                                    </option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                            <p class="mb-1">
                                                                <span class="fw-bold">–ò–º—è:</span>
                                                                {{ order.first_name }} {{ order.last_name }}
                                                            </p>
                                                            <p class="mb-1">
                                                                <span class="fw-bold">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                                                                {% if order.requires_delivery %}{{ order.delivery_address }}{% else %} –°–∞–º–æ–≤—ã–≤–æ–∑{% endif %}
                                                            </p>
                                                            <p class="mb-1">
                                                                <span class="fw-bold">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</span>
                                                                {{ order.created_timestamp|date:"d.m.Y H:i" }}
                                                            </p>
                                                            <p class="mb-1">
                                                                <span class="fw-bold">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞:</span>
                                                                {{ order.phone }}
                                                            </p>
                                                            <p class="mb-1" id="paid-status-{{ order.id }}">
                                                                <span class="fw-bold">–û–ø–ª–∞—Ç–∞:</span>
                                                                {% if order.is_paid %} –û–ø–ª–∞—á–µ–Ω{% else %} –ù–µ –æ–ø–ª–∞—á–µ–Ω{% endif %}
                                                            </p>
                                                            <p class="fw-bold text-muted mb-2 border-bottom pb-1">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:
                                                            </p>
                                                            <ul class="list-unstyled">
                                                                {% for item in order.items.all %}
                                                                    <li class="d-flex align-items-center mb-2 pb-2 border-bottom">

                                                                        {% with image_url=item.part.get_main_image_source %}
                                                                            {% if item.part and image_url %}
                                                                                <img src="{{ image_url }}" alt="{{ item.name }}"
                                                                                     class="me-3 rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                                                            {% else %}
                                                                                <i class="fas fa-box-open fa-2x me-3 text-secondary" style="width: 50px; height: 50px;"></i>
                                                                            {% endif %}
                                                                        {% endwith %}

                                                                        <div class="d-flex flex-column flex-grow-1 me-3">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <a href="#"
                                                                                   data-url="{% url 'spare_parts:part_detail_modal_in_cart' item.part.pk %}"
                                                                                   class="text-dark fw-bold text-decoration-none js-open-part-modal me-2"
                                                                                   style="cursor: pointer;">
                                                                                    {{ item.name|default:"–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                                                                </a>
                                                                                <div class="fw-normal text-muted text-end fs-7 flex-shrink-0">
                                                                                    {{ item.quantity }}&nbsp;—à—Ç. &times; {{ item.price|floatformat:0 }} ‚ÇΩ
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info text-center" role="alert">
                                            –í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="tab-pane fade" id="all-users-content" role="tabpanel" aria-labelledby="all-users-tab">
                                <div class="card p-4 shadow-sm">
                                    <h4 class="card-title mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
                                    {% if all_users %}
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Email</th>
                                                        <th>–ò–º—è</th>
                                                        <th>–†–æ–ª—å</th>
                                                        <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for u in all_users %}
                                                        <tr>
                                                            <td class="align-middle">{{ u.id }}</td>
                                                            <td class="align-middle">{{ u.email }}</td>
                                                            <td class="align-middle">{{ u.get_full_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</td>
                                                            <td class="align-middle">
                                                                {% if u.is_superuser %}
                                                                    <span class="badge bg-danger">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                                                {% else %}
                                                                    <span class="badge bg-success">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="align-middle">
                                                                {% if not u.is_superuser %}
                                                                    <form action="{% url 'users:update_user_status' u.id %}" method="post" class="d-inline admin-user-status-form">
                                                                        {% csrf_token %}
                                                                        <select name="is_active" class="form-select form-select-sm" data-user-id="{{ u.id }}">
                                                                            <option value="True" {% if u.is_active %}selected{% endif %}>–ê–∫—Ç–∏–≤–µ–Ω</option>
                                                                            <option value="False" {% if not u.is_active %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                                                                        </select>
                                                                    </form>
                                                                {% else %}
                                                                    <span class="badge bg-success">–°–∏—Å—Ç–µ–º–∞</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning text-center" role="alert">
                                            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="tab-pane fade" id="data-update-content" role="tabpanel" aria-labelledby="data-update-tab">
                                <div class="card p-4 shadow-sm">
                                    <h4 class="card-title mb-3">–ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</h4>

                                    <p class="text-muted">
                                        –ó–∞–ø—É—Å–∫ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤
                                        donor_cars.xlsx –∏ catalog_parts.xlsx.
                                        –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.
                                    </p>

                                    <form action="{% url 'users:update_catalog' %}" method="post" class="mt-3">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning btn-lg w-100">
                                            <i class="fas fa-file-excel me-2"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                                        </button>
                                    </form>

                                    <div class="alert alert-warning mt-3" role="alert">
                                        ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="{% static 'deps/js/part_modal.js' %}"></script>
<script src="{% static 'deps/js/order_processing.js' %}"></script>
<script src="{% static 'deps/js/user_management.js' %}"></script>

{% endblock %}